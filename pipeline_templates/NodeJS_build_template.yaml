jobs:
- job: ${{ replace(parameters.SERVICENAME, '-', '_') }}_build
  pool:
    name: ocp-dot-adreport1
    demands:
      - AGENT_TYPE -equals $(AGENT_TYPE)
  steps:
  - checkout: CICD_Agent_Portal_NodeJS
    fetchDepth: 0

  - script: |
      echo "Verification of Service : ${{ parameters.SERVICENAME }}"
      echo "Environment variables"
      printenv
    displayName: 'Initialize Environment Variables'
  
  - script: |
      echo "BuildId is : ${BUILD_BUILDID}"
    displayName: 'Print BuildId'

  - task: SonarQubePrepare@4
    displayName: 'Prepare analysis on SonarQube'
    inputs:
      SonarQube: 'SonarQubeDev 7'
      scannerMode: CLI
      configMode: manual
      cliProjectKey: '${{ parameters.SONARPROJECTNAME }}'
      cliProjectName: '${{ parameters.SONARPROJECTNAME }}'
      extraProperties: |
        # Additional properties that will be passed to the scanner, 
        # Put one key=value per line, example:
        sonar.exclusions=node_modules/**, coverage/**, public/**, build/**, **/__tests__/**, test/**
        sonar.projectBaseDir=$(System.DefaultWorkingDirectory)/${{ parameters.SERVICENAME }}
        sonar.javascript.lcov.reportPaths=coverage/lcov.info
    
  - task: SonarQubeAnalyze@4
    displayName: 'Run Code Analysis'
    
  - task: SonarQubePublish@4
    displayName: 'Publish Quality Gate Result'
   
  - task: mspremier.BuildQualityChecks.QualityChecks-task.BuildQualityChecks@6
    displayName: 'Check build quality'
    inputs:
      # ===== Warnings Policy Inputs =====
      checkWarnings: true # Optional
      warningFailOption: fixed # Optional; Valid values: build, fixed
      warningThreshold: '0' # Optional
      # ===== Code Coverage Policy Inputs =====
      checkCoverage: false # Optional
      coverageFailOption: fixed # Optional; Valid values: build, fixed
      coverageType: lines # Optional; Valid values: blocks, lines, branches, custom
      treat0of0as100: true # Optional
      coverageThreshold: '20' # Optional
      coverageUpperThreshold: '80' # Optional
      ignoreDecreaseAboveUpperThreshold: true # Optional
      coverageDeltaType: percentage # Optional; Valid values: absolute, percentage
      coveragePrecision: '4' # Optional
      # ===== Baseline Inputs =====
      includePartiallySucceeded: true # Optional
      # ===== Advanced Inputs =====
      disableCertCheck: true # Optional
      createBuildIssues: true # Optional


  - bash: |
      #! /bin/bash
      #Docker image needs to be tagged with lower casing.
      TAG_NAME=$(echo ${{ parameters.SERVICENAME }}:${BUILD_BUILDID}_${BUILD_SOURCEBRANCHNAME} | tr '[A-Z]' '[a-z]')
      IMAGE_TAG=$(DOCKER_REGISTRY_COMMON)/cicdapp/$TAG_NAME
      echo "##vso[task.setvariable variable=IMAGE_TAG]$IMAGE_TAG"

      #build docker image using the dockerfile cloned from git
      chmod -R 755 docker

      echo "##[debug] Running Docker Commands"
      docker build -t $IMAGE_TAG -f docker/dockerfile --build-arg APP_NAME=${{ parameters.SERVICENAME }} .

      PROCESS_STATUS=$?

      if [ $PROCESS_STATUS -ne 0 ]; then
          echo "##[error] Build failed .. quiting"
          exit 1
      fi
    displayName: 'Create New Docker Image'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - task: trivy@1
    inputs:
      version: 'latest'
      docker: false
      path: '$(Build.SourcesDirectory)'
      aquaKey: '$(AQUA_API_KEY)'
      aquaSecret: '$(AQUA_API_PASSWORD)' 

  - bash: |
      podman login registry.aquasec.com -u ${AQUA_REGISTRY_USERNAME} -p $(AQUA_REGISTRY_PASSWORD)
    displayName: Login to Aqua registry
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

  - task: aquasecScanner@4
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      image: ${IMAGE_TAG}
      scanType: 'local'
      containerRuntime: 'podman'
      hideBase: false
      showNegligible: false
      scanner: 'registry.aquasec.com/scanner:2022.4.460'
      registerCompliant: true 
      registry: 'devops-container-registry'
      connection: 'Aqua - ADO-Image-Scanning-DevOps-Tooling'
      runOptions: '--group-add keep-groups -e XDG_RUNTIME_DIR=$(XDG_RUNTIME_DIR) -e DOCKER_HOST=unix://$(XDG_RUNTIME_DIR)/podman/podman.sock -v $(SPARK_ROOT_CA_CRT):/etc/ssl/certs/ca-certificate.crt'
      caCertificates: true



  - task: CmdLine@2
    displayName: "Manifest Generation"
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs: 
      script: |-
          image = ${IMAGE_TAG}
          export BILLY_SERVER=https://billy.asia-1.codesec.aquasec.com
          curl -sLo install.sh download.codesec.aquasec.com/billy/install.sh
          curl -sLo install.sh.checksum https://github.com/argonsecurity/releases/releases/latest/download/install.sh.checksum
          if ! cat install.sh.checksum | sha256sum --check; then
            echo "install.sh checksum failed"
            exit 1
          fi
          BINDIR="." sh install.sh
          rm install.sh install.sh.checksum
          ./billy generate \
            --access-token $(System.AccessToken) \
            --aqua-key $(AQUA_API_KEY) \
            --aqua-secret $(AQUA_API_PASSWORD) \
            --cspm-url https://asia-1.api.cloudsploit.com \
            --artifact-path $image
          
            # The docker image name:tag of the newly built image
            # --artifact-path  my-image-name:${versionEnv}        
            # OR the path to the root folder of your project. I.e my-repo/my-app 
            # --artifact-path  ${env.MY_APP_ROOT}




  - bash: |
      #! /bin/bash

      #Docker image needs to be tagged with lower casing.
      TAG_NAME=$(echo ${{ parameters.SERVICENAME }}:${BUILD_BUILDID}_${BUILD_SOURCEBRANCHNAME} | tr '[A-Z]' '[a-z]')

      #login to docker registry
      echo "user: $(DEVOPS_CONTAINER_REGISTRY_USER)"
      echo "pwd: $(DEVOPS_CONTAINER_REGISTRY_PWR)"
      echo "Registry: $(DOCKER_REGISTRY_COMMON)"
      podman login -u "$(DEVOPS_CONTAINER_REGISTRY_USER)" -p "$(DEVOPS_CONTAINER_REGISTRY_PWR)" $(DOCKER_REGISTRY_COMMON)
      #docker login -p $(RHCR_TOKEN) $(DOCKER_REGISTRY_COMMON)

      # #Check if docker login succeeded.
      PROCESS_STATUS=$?
      if [ $PROCESS_STATUS -ne 0 ]; then
          echo "Docker login failed .. quiting"
          exit 1
      fi

      #tag docker image using the dockerfile cloned from git
      #docker tag $TAG_NAME $(DOCKER_REGISTRY_COMMON)/cicdapp/$TAG_NAME

      #Push the image to dockerhub

      docker push $IMAGE_TAG

      #check if the Push went through.
      PROCESS_STATUS=$?

      if [ $PROCESS_STATUS -ne 0 ]; then
          echo "Docker push failed .. quiting"
          exit 1
      fi

      #Clean up intermediate images created on the VSTS build machine.
      docker rmi $IMAGE_TAG
      #docker rmi $TAG_NAME
    displayName: 'Tag and push the image'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))